---
title: "Post-Scraper Run Diagnostics"
date: "`r format(Sys.time(), '%a %m/%d/%y')`"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include = F}
library(behindbarstools)
library(tidyverse)
library(googlesheets4)
library(kableExtra)
```

# Comparison to Previous Run

**How do the cumulative totals compare to the previous scraped data?** 

We expect all cumulative variables to increase with each subsequent scraper run. Rows highlighted below indicate that the aggregated total for a given variable fell in the latest scrape. The table compares data from the latest scrape to what is currently on [the Google Sheet](https://docs.google.com/spreadsheets/u/2/d/1X6uJkXXS-O6eePLxw2e4JeRtM41uPZ2eRcOA_HkPVTk/edit#gid=1641553906). 

``` {r check_previous, echo = F, message = F}
# Read latest scraped data 
new_df <- read_scrape_data()

# Read existing Google sheet data 
old_df <- "1X6uJkXXS-O6eePLxw2e4JeRtM41uPZ2eRcOA_HkPVTk" %>%
    read_sheet(sheet = 2, skip = 1) %>%
    .[2:nrow(.),] %>% 
    select(-Notes) %>% 
    setNames(c(
        "Facility.ID", "Jurisdiction", "State", "Name", "Date", "source",
        "Residents.Confirmed", "Staff.Confirmed",
        "Residents.Deaths", "Staff.Deaths", "Residents.Recovered",
        "Staff.Recovered", "Residents.Tadmin", "Staff.Tested", "Residents.Negative",
        "Staff.Negative", "Residents.Pending", "Staff.Pending",
        "Residents.Quarantine", "Staff.Quarantine", "Residents.Active",
        "Population.Feb20", "Address", "Zipcode", "City", "County", "Latitude",
        "Longitude", "County.FIPS", "HIFLD.ID"))

# Get totals 
new_total <- new_df %>% 
    select(-source) %>% 
    select(Residents.Active:Staff.Tested) %>% 
    summarise_all(sum_na_rm) %>% 
    pivot_longer(cols = Residents.Active:Staff.Tested, 
                 names_to = "Variable", 
                 values_to = "New Total")

old_total <- old_df %>% 
    select(Residents.Confirmed:Residents.Active) %>% 
    summarise_all(sum_na_rm) %>% 
    pivot_longer(cols = Residents.Confirmed:Residents.Active, 
                 names_to = "Variable", 
                 values_to = "Old Total")

joined <- full_join(old_total, new_total, by = "Variable") %>% 
    mutate(Difference = `New Total` - `Old Total`)

# Highlight cumulative rows that decreased 
kable(joined, format.args = list(big.mark = ",")) %>% 
    kable_styling(bootstrap_options = "condensed") %>% 
    column_spec(1, border_right = "1px solid #d2d2d2") %>% 
    row_spec(0, align = "c", background = "#f9f9f9") %>% 
    row_spec(which(joined$Difference < 0 & joined$Variable != "Residents.Active"), 
             background = "#ffa07a") %>% 
    scroll_box(height = "250px")
```

# Comparison to AP/Marshall Project

**How does our aggregated data compare to data from AP and the Marshall Project?** 

AP and the Marshall Project report [data on COVID in prisons at the state-level](https://www.themarshallproject.org/2020/05/01/a-state-by-state-look-at-coronavirus-in-prisons) each week. Our methodology differs from theirs in several important ways: 

* Data Sources: We rely exclusively on publicly available information posted by agencies online, whereas AP/TMP acquire additional data through calling agencies and other reporting. 
* Update Frequency: We update our data 3-4 times each week, whereas AP/TMP update their data weekly. 
* Facilities Included: We include data on several large jail systems and immigration detention centers across the country, whereas AP/TMP only include data on jails for six states with unified prison and jail systems (Alaska, Connecticut, Delaware, Hawaii, Rhode Island, Vermont). We also assign counts from federal facilities to the state where the facility is located, whereas AP/TMP report data from federal facilities separately. 

Because of these differences in methodology, we do NOT expect our statewide totals to perfectly align with data from AP/TMP. 

``` {r, echo = F}
# Read Marshall Project data 
mp_df <- "https://raw.githubusercontent.com/themarshallproject/COVID_prison_data/master/data/covid_prison_cases.csv" %>% 
    read.csv() %>% 
    mutate(Date = lubridate::mdy(as_of_date))

# Filter to latest data by date 
mp_total <- mp_df %>% 
    group_by(name) %>% 
    filter(Date == max(Date, na.rm = TRUE)) %>% 
    select(name, total_prisoner_cases, total_prisoner_deaths, total_staff_cases, total_staff_deaths) %>% 
    setNames(c("State", "Residents.Confirmed", "Residents.Deaths", "Staff.Confirmed", "Staff.Deaths")) 

ucla_total <- new_df %>% 
    group_by(State) %>% 
    select(State, Residents.Confirmed, Residents.Deaths, Staff.Confirmed, Staff.Deaths) %>% 
    summarise_all(sum_na_rm) 
    
joined <- full_join(mp_total, ucla_total, 
                    by = "State", 
                    suffix = c(".MP", ".UCLA")) %>% 
    select(State, 
           Residents.Confirmed.MP, Residents.Confirmed.UCLA, 
           Residents.Deaths.MP,  Residents.Deaths.UCLA, 
           Staff.Confirmed.MP, Staff.Confirmed.UCLA, 
           Staff.Deaths.MP, Staff.Deaths.UCLA) %>% 
    janitor::adorn_totals("row") %>% 
    mutate(sort_ = ifelse(State == "Total", 1, 0)) %>% 
    arrange(-sort_, State) %>% 
    select(-sort_)

kable(joined, 
      col.names = c("State", "AP/TMP", "UCLA", "AP/TMP", "UCLA", "AP/TMP", "UCLA", "AP/TMP", "UCLA"), 
      format.args = list(big.mark = ",")) %>% 
    kable_styling(bootstrap_options = c("condensed", "striped")) %>% 
    add_header_above(c(" ", 
                       "Residents.Confirmed" = 2, 
                       "Residents.Deaths" = 2, 
                       "Staff.Confirmed" = 2,
                       "Staff.Deaths" = 2)) %>% 
    row_spec(which(joined$State == "Total"), bold = TRUE) %>% 
    row_spec(0, align = "c") %>% 
    column_spec(c(1, 3, 5, 7), border_right = "1px solid #d2d2d2") %>% 
    scroll_box(height = "250px")
```

# Recent Facility Increases 

## Cumulative Cases 

**Which facilities have seen the greatest increase in cumulative cases among incarcerated residents over the last 7 days?** 

``` {r, echo = F, fig.width = 15, fig.height = 7}
scrape_df <- read_scrape_data(all_dates = TRUE, 
                              coalesce = TRUE)

plot_recent_fac_increases(scrape_df = scrape_df, 
                          plot_days = 30, 
                          num_fac = 5, 
                          auto_label = TRUE) + 
    labs(tag = "") 
```

## Active Cases 

**Which facilities have seen the greatest increase in active cases among incarcerated residents over the last 7 days?**

Note: This includes active cases as reported directly by agencies, along with estimated active cases (where a new cumulative cases is considered active for 14 days). 

``` {r, echo = F, fig.width = 15, fig.height = 7}
plot_recent_fac_increases(scrape_df = scrape_df, 
                          metric = "Residents.Active", 
                          plot_days = 30, 
                          num_fac = 5, 
                          auto_label = TRUE) + 
    labs(tag = "") 
```

# Facilities with New Deaths 

**Which facilities had new deaths since the last scraper run?**

``` {r echo = F}
# Get date of last scrape, and the previous scrape to compare it to 
date_last_scraped <- max(scrape_df$Date)
date_before_last_scrape <- max(scrape_df$Date[scrape_df$Date != max(scrape_df$Date)])

# Calculate change in deaths from previous date scraped
check <- scrape_df %>%
    filter(Date == date_last_scraped | Date == date_before_last_scrape) %>%
    group_by(Name, State, Jurisdiction) %>%
    mutate(previous_death_value = dplyr::lag(Residents.Deaths, order_by = Date)) %>%
    ungroup() %>%
    mutate(change_in_deaths = Residents.Deaths - previous_death_value,
           flag_change_deaths = ifelse(change_in_deaths != 0, TRUE, FALSE)) %>%
    arrange(-flag_change_deaths, -change_in_deaths)

check %>% 
    filter(change_in_deaths != 0) %>%
    select(State, Name, Residents.Deaths, previous_death_value, change_in_deaths) %>% 
    kable(col.names = c("State", "Name", "Current Deaths", "Previous Deaths", "Change")) %>% 
    kable_styling(bootstrap_options = "condensed") %>% 
    row_spec(0, align = "c", background = "#f9f9f9") %>% 
    scroll_box(height = "250px")
```

# New Facility Names 

**Were any new facility names scraped that will need to be added to the facility crosswalks?**

``` {r echo = F}
new_df %>% 
    filter(is.na(Facility.ID)) %>% 
    select(State, Name, Jurisdiction) %>% 
    arrange(State, Name) %>% 
    kable() %>% 
    kable_styling(bootstrap_options = "condensed") %>% 
    row_spec(0, align = "c", background = "#f9f9f9") %>% 
    scroll_box(height = "250px")
```

# Decreasing Cumulative Counts 

## Cumulative Cases 

**Did any facilities see a decrease in cumulative cases?**

``` {r echo = F}
# Get date of last scrape, and the previous scrape to compare it to 
date_last_scraped <- max(scrape_df$Date)
date_before_last_scrape <- max(scrape_df$Date[scrape_df$Date != max(scrape_df$Date)])

# Calculate change in deaths from previous date scraped
check <- scrape_df %>%
    filter(Date == date_last_scraped | Date == date_before_last_scrape) %>%
    group_by(Name, State, Jurisdiction) %>%
    mutate(deaths_previous = dplyr::lag(Residents.Deaths, order_by = Date), 
           cases_previous = dplyr::lag(Residents.Confirmed, order_by = Date)) %>%
    ungroup() %>%
    mutate(deaths_diff = Residents.Deaths - deaths_previous,
           cases_diff = Residents.Confirmed - cases_previous, 
           deaths_neg_flag = ifelse(deaths_diff < 0, 1, 0), 
           cases_neg_flag = ifelse(cases_diff < 0, 1, 0))  

check %>% 
    filter(cases_neg_flag == 1) %>% 
    select(State, Name, Residents.Confirmed, cases_previous, cases_diff) %>% 
    arrange(cases_diff, State, Name) %>% 
    kable(col.names = c("State", "Name", "Current Cases", "Previous Cases", "Change")) %>% 
    kable_styling(bootstrap_options = "condensed") %>% 
    row_spec(0, align = "c", background = "#f9f9f9") %>% 
    scroll_box(height = "250px") 
```

## Cumulative Deaths 

**Did any facilities see a decrease in cumulative deaths?**

``` {r echo = F}
check %>% 
    filter(deaths_neg_flag == 1) %>% 
    select(State, Name, Residents.Deaths, deaths_previous, deaths_diff) %>% 
    arrange(deaths_diff, State, Name) %>% 
    kable(col.names = c("State", "Name", "Current Deaths", "Previous Deaths", "Change")) %>% 
    kable_styling(bootstrap_options = "condensed") %>% 
    row_spec(0, align = "c", background = "#f9f9f9") %>% 
    scroll_box(height = "250px") 
```

# Unsucessful Scrapers 

